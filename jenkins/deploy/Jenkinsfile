#!/usr/bin/env groovy

pipeline {
    agent {
        label 'webserver'
    }

    environment {
        HARBOR_URL     = 'harbor.skytelservices.com'
        HARBOR_PROJECT = 'skytel'
        IMAGE_NAME     = 'oen-management'
        HARBOR_REPO    = "${HARBOR_URL}/${HARBOR_PROJECT}/${IMAGE_NAME}"

        LATEST_TAG   = 'latest'
        PREVIOUS_TAG = 'previous'

        DEPLOY_ENV = 'prod'
        APP_PORT   = '8080'
        APP_COMPOSE_FILE   = 'docker-compose.app.yaml'
        INFRA_COMPOSE_FILE = 'docker-compose.infra.yaml'
    }

    options {
        buildDiscarder(logRotator(numToKeepStr: '10'))
        timeout(time: 30, unit: 'MINUTES')
        disableConcurrentBuilds()
        skipStagesAfterUnstable()
    }

    stages {

        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Prepare Environment') {
            steps {
                dir('docker') {
                    sh '''
                        ENV_FILE=".env"
                        touch "$ENV_FILE"
                        sed -i '/^OEN_SERVER_ENV=/d' "$ENV_FILE" || true
                        echo "OEN_SERVER_ENV=${DEPLOY_ENV}" >> "$ENV_FILE"
                    '''
                }
            }
        }

        stage('Ensure Docker Network') {
            steps {
                sh '''
                    docker network inspect oen-mangement_oen-network >/dev/null 2>&1 || \
                    docker network create --driver bridge oen-mangement_oen-network
                '''
            }
        }

        stage('Start Infrastructure') {
            steps {
                dir('docker') {
                    sh '''
                        docker compose -f ${INFRA_COMPOSE_FILE} up -d

                        echo "‚è≥ Waiting for Postgres to be healthy..."
                        timeout 60s bash -c '
                          until docker exec oen-postgres pg_isready -U oen_db_user -d oen_management_db >/dev/null 2>&1;
                          do
                            sleep 3
                          done
                        '
                    '''
                }
            }
        }

        stage('Backup Current Image (Rollback Safety)') {
            steps {
                sh '''
                    if docker image inspect ${HARBOR_REPO}:${LATEST_TAG} >/dev/null 2>&1; then
                        echo "üì¶ Backing up current image"
                        docker tag ${HARBOR_REPO}:${LATEST_TAG} ${HARBOR_REPO}:${PREVIOUS_TAG}
                        docker push ${HARBOR_REPO}:${PREVIOUS_TAG}
                    else
                        echo "‚ÑπÔ∏è No existing image to backup"
                    fi
                '''
            }
        }

        stage('Stop Application') {
            steps {
                dir('docker') {
                    sh '''
                        docker compose -f ${APP_COMPOSE_FILE} down || true
                    '''
                }
            }
        }

        stage('Pull Latest Image') {
            steps {
                sh '''
                    docker pull ${HARBOR_REPO}:${LATEST_TAG}
                '''
            }
        }

        stage('Start Application') {
            steps {
                dir('docker') {
                    sh '''
                        docker compose -f ${APP_COMPOSE_FILE} up -d
                    '''
                }

                sh '''
                    echo "‚è≥ Waiting for application health..."
                    timeout 60s bash -c '
                      until curl -fs http://localhost:${APP_PORT}/actuator/health >/dev/null
                      do
                        sleep 5
                      done
                    '
                '''
            }
        }

    }

    post {
        success {
            echo """
            ‚úÖ DEPLOYMENT SUCCESSFUL
            üì¶ Image: ${HARBOR_REPO}:${LATEST_TAG}
            üè∑Ô∏è Build: #${env.BUILD_NUMBER}
            üîó Commit: ${env.GIT_COMMIT}
            üåê App: http://localhost:${APP_PORT}
            üóÑÔ∏è PgAdmin: http://localhost:5050
            """

            echo "üßπ Cleaning unused Docker images (SAFE)..."
            sh '''
                docker image prune -f
            '''
        }

        failure {
            echo """
            ‚ùå DEPLOYMENT FAILED
            ‚ö†Ô∏è Attempting rollback to previous image
            """

            dir('docker') {
                sh '''
                    docker compose -f ${APP_COMPOSE_FILE} down || true
                '''
            }

            sh '''
                if docker image inspect ${HARBOR_REPO}:${PREVIOUS_TAG} >/dev/null 2>&1; then
                    echo "‚Ü©Ô∏è Rolling back to previous image"
                    docker pull ${HARBOR_REPO}:${PREVIOUS_TAG}
                    docker tag ${HARBOR_REPO}:${PREVIOUS_TAG} ${HARBOR_REPO}:${LATEST_TAG}
                    docker compose -f ${APP_COMPOSE_FILE} up -d
                else
                    echo "‚ùå No previous image available ‚Äî rollback skipped"
                fi
            '''
        }

        always {
            cleanWs()
        }
    }
}
