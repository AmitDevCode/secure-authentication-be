#!/usr/bin/env groovy

pipeline {
    agent any

    environment {
        DOCKER_IMAGE = 'secure-authentication-be'
        APP_COMPOSE_FILE   = 'docker-compose.app.yaml'
        INFRA_COMPOSE_FILE = 'docker-compose.infra.yaml'
        APP_PORT=8085
        DOCKER_TAG='latest'
        DEPLOY_ENV='prod'
    }

    options {
        buildDiscarder(logRotator(numToKeepStr: '10'))
        timeout(time: 45, unit: 'MINUTES')
        skipStagesAfterUnstable()
        disableConcurrentBuilds()
        timestamps()
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
                script {
                    env.GIT_COMMIT = sh(script: 'git rev-parse --short HEAD', returnStdout: true).trim()
                    env.BRANCH_NAME = sh(script: 'git rev-parse --abbrev-ref HEAD', returnStdout: true).trim()
                }
                echo "ğŸ”„ Checked out commit: ${env.GIT_COMMIT}"
                echo "ğŸ”„ Branch: ${env.BRANCH_NAME}"
                echo "ğŸ”— Commit: ${env.GIT_COMMIT}"
            }
        }

        stage('SonarQube Analysis') {
            withSonarQubeEnv() {
              sh "./gradlew sonar"
            }
        }

        stage('Prepare Environment') {
            steps {
                dir('docker') {
                    sh '''
                        ENV_FILE=".env"
                        touch "$ENV_FILE"
                        sed -i '/^AUTHENTICATION_SERVER_ENV=/d' "$ENV_FILE" || true
                        echo "AUTHENTICATION_SERVER_ENV=${DEPLOY_ENV}" >> "$ENV_FILE"
                    '''
                }
            }
        }

        stage('Ensure Docker Network') {
            steps {
                sh '''
                    docker network inspect authentication-network >/dev/null 2>&1 || \
                    docker network create --driver bridge authentication-network
                '''
            }
        }

        stage('Start Infrastructure') {
            steps {
                dir('docker') {
                    sh '''
                        if docker inspect --format="{{.State.Health.Status}}" authentication-postgres 2>/dev/null | grep -q "healthy"; then
                            echo "âœ… Postgres is already healthy â€” skipping infra startup."
                        else
                            echo "ğŸš€ Starting infrastructure..."
                            docker compose -p ${DOCKER_IMAGE} -f ${INFRA_COMPOSE_FILE} up -d

                            echo "â³ Waiting for Postgres to be healthy..."
                            timeout 60s bash -c '
                            until docker inspect --format="{{.State.Health.Status}}" authentication-postgres | grep -q healthy
                            do
                                sleep 3
                            done
                            '
                        fi
                    '''
                }
            }
        }

        stage('Build Docker Image') {
            steps {
                script {
                    sh """
                        docker build \
                          -t ${DOCKER_IMAGE}:${DOCKER_TAG} \
                          -t ${DOCKER_IMAGE}:${GIT_COMMIT} \
                          -t ${DOCKER_IMAGE}:latest \
                          --label version=${GIT_COMMIT} \
                          --label build-number=${BUILD_NUMBER} \
                          .
                    """
                }
            }
        }

        stage('Deploy Application') {
            steps {
                dir('docker') {
                    sh """
                        export APP_IMAGE=${DOCKER_IMAGE}:${DOCKER_TAG}

                        docker compose -f ${APP_COMPOSE_FILE} down
                        docker compose -f ${APP_COMPOSE_FILE} up -d --remove-orphans
                    """
                }
            }
        }

        stage('Health Check') {
            steps {
                sh """
                    echo "â³ Waiting for application health..."
                    timeout 90s bash -c '
                    until curl -sf http://192.168.1.128:8085/actuator/health >/dev/null
                    do
                      sleep 5
                    done
                    '
                """
            }
        }
    }

    post {
        success {
            echo """
            âœ… DEPLOYMENT SUCCESSFUL
            ğŸ“¦ Image: ${DOCKER_IMAGE}:${DOCKER_TAG}
            ğŸ”— Commit: ${GIT_COMMIT}
            ğŸ·ï¸ Build: #${BUILD_NUMBER}
            ğŸŒ App: http://192.168.1.128:${APP_PORT}
            ğŸ—„ï¸ PgAdmin: http://192.168.1.128:5050
            """
        }

        failure {
            echo """
            âŒ DEPLOYMENT FAILED
            ğŸ”— Commit: ${GIT_COMMIT}
            ğŸ·ï¸ Build: #${BUILD_NUMBER}
            """
        }

        always {
            script {
                sh """
                    docker image prune -f || true
                """
            }
        }
    }
}
